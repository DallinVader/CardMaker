<!DOCTYPE html>
<link rel="stylesheet" href="style.css">
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Card Maker</title>
    </head>
    <body>
        <h1 style="text-align: center;">Card Maker</h1>
        
        <div class="main-container">
            <div class="card-preview">
                <canvas id="cardCanvas" width="2500" height="3500"></canvas>
            </div>
            
            <div class="controls-panel">
                <div class="controls">
                    <div class="input-group">
                        <label>Card Base/Frame:</label>
                        <input type="file" id="CardBase" accept="image/*">
                    </div>
                    <div class="input-group">
                        <label>Art Image:</label>
                        <input type="file" id="Art" accept="image/*" multiple>
                    </div>
                    <label for="downloadScale">Download Scale:</label>
                    <select id="downloadScale">
                        <option value="1">1 (Full Size)</option>
                        <option value="0.75">0.75</option>
                        <option value="0.5">0.5</option>
                        <option value="0.25">0.25</option>
                    </select>
                    <button onclick="downloadCard()">Download Card</button>
                    <button onclick="openFullscreen()">Fullscreen Card</button>
                    <button onclick="resetEverything()" style="background-color: #ff6b6b; color: white;">Reset All</button>
                </div>
                
                <div class="control-section">
                    <h2>Art Size</h2>
                    <div class="input-group">
                        <label>Art Size (%):</label>
                        <input value="116" type="number" min="1" max="500" placeholder="Size" id="ArtHight" oninput="ImageSize()">
                        <small>Drag the bottom-right corner on the card to resize, or type a value</small>
                    </div>
                </div>
                
                <div class="control-section">
                    <h2>Art Position</h2>
                    <div class="input-group">
                        <label>Vertical Position (Y):</label>
                        <input value="0" type="number" min="-5000" max="5000" placeholder="0" id="ArtHightPos" oninput="ImagePos()">
                        <small>Drag the art image on the card to move, or type a value</small>
                    </div>
                    <div class="input-group">
                        <label>Horizontal Position (X):</label>
                        <input value="0" type="number" min="-5000" max="5000" placeholder="0" id="ArtWidthPos" oninput="ImagePos()">
                        <small>Negative moves left, positive moves right</small>
                    </div>
                </div>
                
                <div class="control-section">
                    <h2>Title</h2>
                    <div class="input-group">
                        <label>Title Text:</label>
                        <input type="text" placeholder="Enter card title" id="Title" oninput="redrawCanvas()">
                    </div>
                    <div class="input-group">
                        <label>Font Size: <span id="TitleFontSizeValue">200</span></label>
                        <input type="range" id="TitleFontSize" min="50" max="300" value="200" oninput="redrawCanvas()">
                        <div class="quick-buttons">
                            <button type="button" onclick="setFontSize('TitleFontSize', 150)">Small</button>
                            <button type="button" onclick="setFontSize('TitleFontSize', 200)">Medium</button>
                            <button type="button" onclick="setFontSize('TitleFontSize', 250)">Large</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Center Align:</label>
                        <input type="checkbox" id="TitleCenterAlign" checked onchange="redrawCanvas()">
                    </div>
                </div>
                
                <div class="control-section">
                    <h2>Damage Stats</h2>
                    <div class="input-group">
                        <label>Show Stats:</label>
                        <input type="checkbox" onclick="ToggelSwitch()" checked>
                    </div>
                    <div class="input-group">
                        <label>Damage:</label>
                        <input type="number" value="0" min="0" max="999" placeholder="0" id="DamageID" oninput="redrawCanvas()">
                    </div>
                    <div class="input-group">
                        <label>Defense:</label>
                        <input type="number" value="0" min="0" max="999" placeholder="0" id="DefenseID" oninput="redrawCanvas()">
                    </div>
                </div>
                
                <div class="control-section">
                    <h2>Types</h2>
                    <div class="input-group">
                        <label>Type:</label>
                        <input type="text" placeholder="Enter type" oninput="redrawCanvas()" id="Type" value="">
                    </div>
                    <div class="input-group">
                        <label>Type Font Size: <span id="TypeFontSizeValue">100</span></label>
                        <input type="range" id="TypeFontSize" min="50" max="200" oninput="redrawCanvas()" value="100">
                    </div>
                    <div class="input-group">
                        <label>Subtype:</label>
                        <input type="text" placeholder="Enter subtype" oninput="redrawCanvas()" id="Subtype" value="">
                    </div>
                    <div class="input-group">
                        <label>Subtype Font Size: <span id="SubtypeFontSizeValue">80</span></label>
                        <input type="range" id="SubtypeFontSize" min="50" max="200" oninput="redrawCanvas()" value="80">
                    </div>
                </div>
                
                <div class="control-section">
                    <h2>Treasure Cost</h2>
                    <div class="input-group">
                        <label>Cost:</label>
                        <input type="number" id="TreasureCost" placeholder="0" value="0" min="0" max="999" oninput="redrawCanvas()">
                    </div>
                    <div class="input-group">
                        <label>Font Size: <span id="TreasureFontSizeValue">150</span></label>
                        <input type="range" id="TreasureFontSize" min="50" max="300" value="150" oninput="redrawCanvas()">
                    </div>
                </div>
                
                <div class="control-section">
                    <h2>Description</h2>
                    <div class="input-group">
                        <label>Main Description:</label>
                        <textarea id="MainDisciption" placeholder="Enter main description (supports multiple lines)" rows="3" oninput="redrawCanvas()"></textarea>
                    </div>
                    <div class="input-group">
                        <label>Font Size: <span id="MainDisciptionFontSizeValue">80</span></label>
                        <input type="range" id="MainDisciptionFontSize" min="50" max="200" value="80" oninput="redrawCanvas()">
                    </div>
                    <div class="input-group">
                        <label>Center Align:</label>
                        <input type="checkbox" id="MainDescriptionCenterAlign" onchange="redrawCanvas()">
                    </div>
                </div>
                
                <div class="control-section">
                    <h2>Sub Description</h2>
                    <div class="input-group">
                        <label>Sub Description:</label>
                        <textarea id="SubDisciption" placeholder="Enter sub description (supports multiple lines)" rows="2" oninput="redrawCanvas()"></textarea>
                    </div>
                    <div class="input-group">
                        <label>Font Size: <span id="SubDisciptionFontSizeValue">70</span></label>
                        <input type="range" id="SubDisciptionFontSize" min="50" max="200" value="70" oninput="redrawCanvas()">
                    </div>
                    <div class="input-group">
                        <label>Center Align:</label>
                        <input type="checkbox" id="SubDescriptionCenterAlign" checked onchange="redrawCanvas()">
                    </div>
                </div>
                
                <div class="control-section">
                    <h2>Quote</h2>
                    <div class="input-group">
                        <label>Quote Text:</label>
                        <textarea id="QoteDiscription" placeholder="Enter quote text" rows="2" oninput="redrawCanvas()"></textarea>
                    </div>
                    <div class="input-group">
                        <label>Font Size: <span id="QoteDiscriptionFontSizeValue">60</span></label>
                        <input type="range" id="QoteDiscriptionFontSize" min="50" max="200" value="60" oninput="redrawCanvas()">
                    </div>
                    <div class="input-group">
                        <label>Center Align:</label>
                        <input type="checkbox" id="QuoteCenterAlign" checked onchange="redrawCanvas()">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Fullscreen Modal -->
        <div id="fullscreenModal" class="fullscreen-modal" onclick="closeFullscreen()">
            <div class="fullscreen-content" onclick="event.stopPropagation()">
                <span class="close-fullscreen" onclick="closeFullscreen()">&times;</span>
                <canvas id="fullscreenCanvas" width="2500" height="3500"></canvas>
            </div>
        </div>

    <script>
        const canvas = document.getElementById('cardCanvas');
        const ctx = canvas.getContext('2d');

        let IsSwitchedOn = true;
        Dam = document.getElementById("DamageID");
        Def = document.getElementById("DefenseID");

        TitleSize = document.getElementById("TitleFontSize");
        CardTitle = document.getElementById("Title");

        Type = document.getElementById("Type");
        Subtype = document.getElementById("Subtype");
        TypeFontSize = document.getElementById("TypeFontSize");
        SubtypeFontSize = document.getElementById("SubtypeFontSize");

        TreasureCost = document.getElementById("TreasureCost");
        TreasureFontSize = document.getElementById("TreasureFontSize");

        Discription = document.getElementById("MainDisciption");
        DiscriptionFontSize = document.getElementById("MainDisciptionFontSize");

        SubDisciption = document.getElementById("SubDisciption");
        SubFontSize = document.getElementById("SubDisciptionFontSize");

        Quote = document.getElementById("QoteDiscription");
        QuoteFontSize = document.getElementById("QoteDiscriptionFontSize");
        
        // Alignment checkboxes
        TitleCenterAlign = document.getElementById("TitleCenterAlign");
        MainDescriptionCenterAlign = document.getElementById("MainDescriptionCenterAlign");
        SubDescriptionCenterAlign = document.getElementById("SubDescriptionCenterAlign");
        QuoteCenterAlign = document.getElementById("QuoteCenterAlign");
        
        // Update font size displays
        function updateFontSizeDisplay() {
            document.getElementById("TitleFontSizeValue").textContent = TitleSize.value;
            document.getElementById("TypeFontSizeValue").textContent = TypeFontSize.value;
            document.getElementById("SubtypeFontSizeValue").textContent = SubtypeFontSize.value;
            document.getElementById("TreasureFontSizeValue").textContent = TreasureFontSize.value;
            document.getElementById("MainDisciptionFontSizeValue").textContent = DiscriptionFontSize.value;
            document.getElementById("SubDisciptionFontSizeValue").textContent = SubFontSize.value;
            document.getElementById("QoteDiscriptionFontSizeValue").textContent = QuoteFontSize.value;
        }
        
        // Add event listeners to update font size displays
        TitleSize.addEventListener('input', updateFontSizeDisplay);
        TypeFontSize.addEventListener('input', updateFontSizeDisplay);
        SubtypeFontSize.addEventListener('input', updateFontSizeDisplay);
        TreasureFontSize.addEventListener('input', updateFontSizeDisplay);
        DiscriptionFontSize.addEventListener('input', updateFontSizeDisplay);
        SubFontSize.addEventListener('input', updateFontSizeDisplay);
        QuoteFontSize.addEventListener('input', updateFontSizeDisplay);
        
        // Initialize font size displays
        updateFontSizeDisplay();

        // Drag and resize functionality for art image
        let isDragging = false;
        let isResizing = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let startArtX = 0;
        let startArtY = 0;
        let startArtSize = 0;
        let artBounds = { x: 0, y: 0, width: 0, height: 0 };
        let canvasScale = 1;
        let canvasOffsetX = 0;
        let canvasOffsetY = 0;
        
        // Calculate canvas scale and offset for mouse coordinate conversion
        function updateCanvasTransform() {
            const rect = canvas.getBoundingClientRect();
            canvasScale = canvas.width / rect.width;
            canvasOffsetX = rect.left;
            canvasOffsetY = rect.top;
        }
        
        // Get mouse position in canvas coordinates
        function getCanvasMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }
        
        // Calculate art image bounds
        function calculateArtBounds() {
            const ExtraHightP = parseInt(document.getElementById("ArtHightPos").value) || 0;
            const ExtraWidthP = parseInt(document.getElementById("ArtWidthPos").value) || 0;
            const artSize = ArtImage.h || 116;
            const mgWidth = ArtImage.width * (artSize / 100);
            const mgHeight = ArtImage.height * (artSize / 100);
            const x = (canvas.width - mgWidth - ExtraWidthP) / 2;
            const y = (canvas.height - mgHeight - ExtraHightP) / 8;
            
            artBounds = { x, y, width: mgWidth, height: mgHeight };
            return artBounds;
        }
        
        // Check if point is inside art image
        function isPointInArt(x, y) {
            calculateArtBounds();
            return x >= artBounds.x && x <= artBounds.x + artBounds.width &&
                   y >= artBounds.y && y <= artBounds.y + artBounds.height;
        }
        
        // Check if point is near resize handle (bottom-right corner)
        function isPointNearResizeHandle(x, y) {
            calculateArtBounds();
            const handleSize = 40; // Larger handle for easier grabbing
            const handleX = artBounds.x + artBounds.width;
            const handleY = artBounds.y + artBounds.height;
            return Math.abs(x - handleX) < handleSize && Math.abs(y - handleY) < handleSize;
        }
        
        // Check if point is near vertical edge for easier Y-axis dragging
        function isPointNearVerticalEdge(x, y) {
            calculateArtBounds();
            const edgeTolerance = 30; // Wider tolerance for vertical edges
            const nearLeftEdge = Math.abs(x - artBounds.x) < edgeTolerance;
            const nearRightEdge = Math.abs(x - (artBounds.x + artBounds.width)) < edgeTolerance;
            const inVerticalRange = y >= artBounds.y && y <= artBounds.y + artBounds.height;
            return (nearLeftEdge || nearRightEdge) && inVerticalRange;
        }
        
        // Mouse down event
        canvas.addEventListener('mousedown', function(e) {
            if (!ArtImage.src) return;
            
            const mousePos = getCanvasMousePos(e);
            updateCanvasTransform();
            
            if (isPointNearResizeHandle(mousePos.x, mousePos.y)) {
                isResizing = true;
                startArtSize = ArtImage.h || 116;
                dragStartX = mousePos.x;
                dragStartY = mousePos.y;
                canvas.style.cursor = 'nwse-resize';
            } else if (isPointInArt(mousePos.x, mousePos.y) || isPointNearVerticalEdge(mousePos.x, mousePos.y)) {
                isDragging = true;
                startArtX = parseInt(document.getElementById("ArtWidthPos").value) || 0;
                startArtY = parseInt(document.getElementById("ArtHightPos").value) || 0;
                dragStartX = mousePos.x;
                dragStartY = mousePos.y;
                canvas.style.cursor = 'move';
            }
        });
        
        // Mouse move event
        canvas.addEventListener('mousemove', function(e) {
            if (!ArtImage.src) return;
            
            const mousePos = getCanvasMousePos(e);
            calculateArtBounds();
            
            // Update cursor
            if (isResizing) {
                canvas.style.cursor = 'nwse-resize';
            } else if (isDragging) {
                canvas.style.cursor = 'move';
            } else if (isPointNearResizeHandle(mousePos.x, mousePos.y)) {
                canvas.style.cursor = 'nwse-resize';
            } else if (isPointInArt(mousePos.x, mousePos.y) || isPointNearVerticalEdge(mousePos.x, mousePos.y)) {
                canvas.style.cursor = 'move';
            } else {
                canvas.style.cursor = 'default';
            }
            
            if (isDragging) {
                // Calculate movement in canvas coordinates
                const deltaX = mousePos.x - dragStartX;
                const deltaY = mousePos.y - dragStartY;
                
                // Make Y-axis movement more sensitive (multiply by 1.5 for easier vertical dragging)
                const sensitivityY = 1.5;
                
                // Update position (inverse because positive Y moves down in canvas but we want negative to move up)
                const newX = startArtX - deltaX;
                const newY = startArtY - (deltaY * sensitivityY);
                
                document.getElementById("ArtWidthPos").value = Math.round(newX);
                document.getElementById("ArtHightPos").value = Math.round(newY);
                ImagePos();
            } else if (isResizing) {
                // Calculate size based on distance from center - make it more sensitive
                const startCenterX = artBounds.x + artBounds.width / 2;
                const startCenterY = artBounds.y + artBounds.height / 2;
                const startDistance = Math.sqrt(
                    Math.pow(dragStartX - startCenterX, 2) + 
                    Math.pow(dragStartY - startCenterY, 2)
                );
                const currentDistance = Math.sqrt(
                    Math.pow(mousePos.x - startCenterX, 2) + 
                    Math.pow(mousePos.y - startCenterY, 2)
                );
                
                // Increase sensitivity for resizing (multiply by 1.3)
                const sizeChange = (currentDistance / startDistance) * startArtSize * 1.3;
                const newSize = Math.max(10, Math.min(500, Math.round(sizeChange)));
                
                document.getElementById("ArtHight").value = newSize;
                ImageSize();
            }
        });
        
        // Mouse up event
        canvas.addEventListener('mouseup', function(e) {
            isDragging = false;
            isResizing = false;
            canvas.style.cursor = 'default';
        });
        
        // Mouse leave event
        canvas.addEventListener('mouseleave', function(e) {
            isDragging = false;
            isResizing = false;
            canvas.style.cursor = 'default';
        });
        
        // Redraw with visual feedback on hover
        let hoverRedrawTimeout;
        canvas.addEventListener('mousemove', function(e) {
            if (isDragging || isResizing) return;
            
            clearTimeout(hoverRedrawTimeout);
            hoverRedrawTimeout = setTimeout(() => {
                const mousePos = getCanvasMousePos(e);
                if (ArtImage.src && isPointInArt(mousePos.x, mousePos.y)) {
                    redrawCanvasWithHover();
                } else {
                    redrawCanvas();
                }
            }, 50);
        });

        const images = [];
        let MainImage = new Image();
        MainImage.src = "CardFrame.png"
        MainImage.hy = 0;
        MainImage.wx = 0;
        DamageImg = new Image();
        DamageImg.src = "Damage.png"
        DamageImg.hy = 0;
        DamageImg.wx = 0;
        ArtImage = new Image();
        ArtImage.hy = 0;
        ArtImage.wx = 0;
        ArtImage.src = "The lIch King.png";
        ArtImage.onload = function() {
            ImageSizeNoRedraw();
            redrawCanvas();
        };
        MainImage.onload = function () {
            redrawCanvas();
        }

        function ToggelSwitch() {
            IsSwitchedOn = !IsSwitchedOn;
            console.log("Switched " + IsSwitchedOn)
            redrawCanvas();
        }

        function ImagePos() {
            const ExtraHightPos = parseInt(document.getElementById("ArtHightPos").value) || 0;
            const ExtraWidthPos = parseInt(document.getElementById("ArtWidthPos").value) || 0;
            
            ArtImage.hy = ExtraHightPos;
            ArtImage.wx = ExtraWidthPos;
            redrawCanvas()
        }

        function ImageSize() {
            const ExtraHight = parseInt(document.getElementById("ArtHight").value) || 100;
            
            ArtImage.h = ExtraHight;
            ArtImage.w = ExtraHight; // Use same value for both width and height
            redrawCanvas()
        }

        function ImageSizeNoRedraw() {
            const ExtraHight = parseInt(document.getElementById("ArtHight").value) || 100;
            
            ArtImage.h = ExtraHight;
            ArtImage.w = ExtraHight; // Use same value for both width and height
        }
        
        // Quick font size preset function
        function setFontSize(elementId, size) {
            const element = document.getElementById(elementId);
            element.value = size;
            element.dispatchEvent(new Event('input'));
        }
        
        // Reset everything to defaults
        function resetEverything() {
            if (!confirm('Are you sure you want to reset everything? This will clear all your current settings.')) {
                return;
            }
            
            // Reset file inputs
            document.getElementById("CardBase").value = '';
            document.getElementById("Art").value = '';
            
            // Reset art position
            document.getElementById("ArtHightPos").value = 0;
            document.getElementById("ArtWidthPos").value = 0;
            
            // Reset art size
            document.getElementById("ArtHight").value = 116;
            
            // Reset title
            document.getElementById("Title").value = '';
            document.getElementById("TitleFontSize").value = 200;
            document.getElementById("TitleCenterAlign").checked = true;
            
            // Reset damage stats
            document.getElementById("DamageID").value = 0;
            document.getElementById("DefenseID").value = 0;
            const damageCheckbox = document.querySelector('input[type="checkbox"][onclick="ToggelSwitch()"]');
            if (damageCheckbox) damageCheckbox.checked = true;
            IsSwitchedOn = true;
            
            // Reset types
            document.getElementById("Type").value = '';
            document.getElementById("TypeFontSize").value = 100;
            document.getElementById("Subtype").value = '';
            document.getElementById("SubtypeFontSize").value = 80;
            
            // Reset treasure cost
            document.getElementById("TreasureCost").value = 0;
            document.getElementById("TreasureFontSize").value = 150;
            
            // Reset descriptions
            document.getElementById("MainDisciption").value = '';
            document.getElementById("MainDisciptionFontSize").value = 80;
            document.getElementById("MainDescriptionCenterAlign").checked = false;
            document.getElementById("SubDisciption").value = '';
            document.getElementById("SubDisciptionFontSize").value = 70;
            document.getElementById("SubDescriptionCenterAlign").checked = true;
            document.getElementById("QoteDiscription").value = '';
            document.getElementById("QoteDiscriptionFontSize").value = 60;
            document.getElementById("QuoteCenterAlign").checked = true;
            
            // Reset images to defaults
            MainImage = new Image();
            MainImage.src = "CardFrame.png";
            MainImage.hy = 0;
            MainImage.wx = 0;
            MainImage.onload = function() {
                redrawCanvas();
            };
            
            ArtImage = new Image();
            ArtImage.src = "The lIch King.png";
            ArtImage.hy = 0;
            ArtImage.wx = 0;
            ArtImage.onload = function() {
                ImageSizeNoRedraw();
                redrawCanvas();
            };
            
            // Update font size displays
            updateFontSizeDisplay();
            
            // Redraw canvas
            redrawCanvas();
        }

        // Card base/frame file upload
        document.getElementById("CardBase").addEventListener("change", function (event) {
            let file = event.target.files[0];
            if (!file) return;
            
            let img = new Image();
            let reader = new FileReader();
            
            reader.onload = function(e) {
                img.src = e.target.result;
            };
            
            reader.onloadend = function() {
                MainImage = img;
                MainImage.hy = 0;
                MainImage.wx = 0;
                MainImage.onload = function() {
                    redrawCanvas();
                };
            };
            
            reader.readAsDataURL(file);
        });
        
        // Art image file upload
        document.getElementById("Art").addEventListener("change", function (event) {
            let file = event.target.files;
            let img = new Image();
            let reader = new FileReader();
            
            reader.onload = function(e) {
                img.src = e.target.result; // Set image source to uploaded file as data URL
            };

            const ExtraHight = parseInt(document.getElementById("ArtHightPos").value) || 0;
            
            reader.onloadend = function() {
                ArtImage.hy = ExtraHight;
                ArtImage = img;
                ArtImage.onload = function() {
                    ImageSizeNoRedraw();
                    redrawCanvas();   // Redraw the canvas
                };
            };

            reader.readAsDataURL(file[0]); // Read the first file as data URL
        });

        // Redraw canvas with hover outline
        function redrawCanvasWithHover() {
            redrawCanvas();
            if (!ArtImage.src) return;
            
            calculateArtBounds();
            ctx.strokeStyle = 'rgba(0, 150, 255, 0.8)';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(artBounds.x, artBounds.y, artBounds.width, artBounds.height);
            ctx.setLineDash([]);
            
            // Draw resize handle (larger for easier grabbing)
            const handleSize = 25;
            ctx.fillStyle = 'rgba(0, 150, 255, 0.9)';
            ctx.fillRect(
                artBounds.x + artBounds.width - handleSize/2,
                artBounds.y + artBounds.height - handleSize/2,
                handleSize,
                handleSize
            );
            
            // Draw vertical edge indicators for easier Y-axis dragging
            const edgeWidth = 4;
            ctx.fillStyle = 'rgba(0, 150, 255, 0.5)';
            // Left edge
            ctx.fillRect(artBounds.x - edgeWidth/2, artBounds.y, edgeWidth, artBounds.height);
            // Right edge
            ctx.fillRect(artBounds.x + artBounds.width - edgeWidth/2, artBounds.y, edgeWidth, artBounds.height);
            
            // Reset fillStyle to black after drawing hover indicators
            ctx.fillStyle = 'black';
        }
        
        // Redraw the canvas with all images and text
        function redrawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'black'; // Reset fillStyle to black at the start
        
            // Get the value of ExtraHight (add a check if it is set, to avoid NaN issues)
            const ExtraHightP = parseInt(document.getElementById("ArtHightPos").value) || 0;
            const ExtraWidthP = parseInt(document.getElementById("ArtWidthPos").value) || 0;
            
            //Draw art image
            const spectRatio = MainImage.width / MainImage.height;
            if (ArtImage.src) {
                ImageSizeNoRedraw();
            }
            const artSize = ArtImage.h || 116;
            let mgWidth = ArtImage.width * (artSize / 100);
            let mgHeight = ArtImage.height * (artSize / 100);

            ctx.drawImage(ArtImage, (canvas.width - mgWidth - ExtraWidthP) / 2, (canvas.height - mgHeight - ExtraHightP) / 8, mgWidth, mgHeight);

            //Draw frame
            const aspectRatio = MainImage.width / MainImage.height;
            let imgWidth = canvas.width;
            let imgHeight = imgWidth / aspectRatio;

            if (imgHeight > canvas.height) {
                imgHeight = canvas.height;
                imgWidth = imgHeight * aspectRatio;
            }
            ctx.drawImage(MainImage, (canvas.width - imgWidth) / 2, (canvas.height - imgHeight) / 8, imgWidth, imgHeight);
            
            ctx.font = "200px Medieval"
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = 'black';
            
            //Draw damage stats
            if (IsSwitchedOn) {
                const aspectRatios = MainImage.width / MainImage.height;
                let DimgWidth = canvas.width;
                let DimgHeight = imgWidth / aspectRatios;
    
                if (DimgHeight > canvas.height) {
                    DimgHeight = canvas.height;
                    DimgWidth = DimgHeight * aspectRatios;
                }
                ctx.drawImage(DamageImg, (canvas.width - DimgWidth) / 2, (canvas.height - DimgHeight) / 8, DimgWidth, DimgHeight);
                

                document.fonts.load('10px Medieval').then(() => {
                    ctx.font = "175px Medieval"
                    ctx.textAlign = 'center';
                    ctx.fillStyle = 'black';
                    ctx.fillText(Dam.value, canvas.width / 12.5, canvas.height / 12.5)
                    ctx.fillText(Def.value, canvas.width - (canvas.width / 12.5), canvas.height / 12.5)
                })

            }
            
            ctx.font = TitleSize.value + "px Medieval"
            ctx.textAlign = TitleCenterAlign.checked ? 'center' : 'left';
            const titleX = TitleCenterAlign.checked ? (canvas.width / 2) : (canvas.width / 10);
            ctx.fillText(CardTitle.value, titleX, canvas.height / 12.5)

            ctx.font = TypeFontSize.value + "px Medieval"
            ctx.textAlign = 'center';
            ctx.fillText(Type.value, (canvas.width / 5), canvas.height /7.3)
            ctx.font = SubtypeFontSize.value + "px Medieval"
            ctx.textAlign = 'center';
            ctx.fillText(Subtype.value, canvas.width - (canvas.width / 5), canvas.height /7.3)

            ctx.font = TreasureFontSize.value + "px Medieval"
            ctx.textAlign = 'center';
            ctx.fillText(TreasureCost.value, canvas.width - (canvas.width / 6.9), canvas.height / 1.99)


            ctx.font = QuoteFontSize.value + "px Medieval"
            ctx.textAlign = QuoteCenterAlign.checked ? 'center' : 'left';
            const quoteX = QuoteCenterAlign.checked ? (canvas.width / 2) : (canvas.width / 10);
            ctx.fillText(Quote.value, quoteX, canvas.height - (canvas.height / 13))


            ctx.font = DiscriptionFontSize.value + "px Medieval"
            ctx.textAlign = MainDescriptionCenterAlign.checked ? 'center' : 'left';
            const descriptionX = MainDescriptionCenterAlign.checked ? (canvas.width / 2) : (canvas.width / 10);
            i = 0;
            WrapText(Discription.value).forEach(lin => {
                i++;
                ctx.fillText(lin, descriptionX, (canvas.height / 1.6) + (125 * i))
            });


            ctx.font = SubFontSize.value + "px Medieval"
            ctx.textAlign = SubDescriptionCenterAlign.checked ? 'center' : 'left';
            const subDescriptionX = SubDescriptionCenterAlign.checked ? (canvas.width / 2) : (canvas.width / 10);
            i = 0;
            WrapText(SubDisciption.value).forEach(lin => {
                i++;
                ctx.fillText(lin, subDescriptionX, (canvas.height / 1.9) + (100 * i))
            });
            
            // Update fullscreen canvas if modal is open
            const modal = document.getElementById('fullscreenModal');
            if (modal.style.display === 'block') {
                const fullscreenCanvas = document.getElementById('fullscreenCanvas');
                const fullscreenCtx = fullscreenCanvas.getContext('2d');
                fullscreenCtx.clearRect(0, 0, fullscreenCanvas.width, fullscreenCanvas.height);
                fullscreenCtx.drawImage(canvas, 0, 0);
            }
        }

        function WrapText(Text) {
            const words = Text.split(' ');
            let line = '';
            const lines = [];
            const maxWidth = canvas.width - (canvas.width / 4.75); // Set max width for text wrapping (adjust as necessary)

            // Loop through words and wrap text
            for (let index = 0; index < words.length; index++) {
                const word = words[index];
                const testLine = line + word + ' '; // Add the word to the current line

                // Check the width of the text to determine if it exceeds maxWidth
                if (ctx.measureText(testLine).width > maxWidth) {
                    if (line.length > 0) {
                        lines.push(line.trim()); // Push the current line to the lines array
                    }
                    line = word + ' '; // Start a new line with the current word
                } else {
                    line = testLine; // Continue adding to the current line
                }
            }

            // Add the remaining text as a line
            if (line.length > 0) {
                lines.push(line.trim());
            }

            return lines;
        }



        // Download the final card at the selected scale
        function downloadCard() {
            // Get the selected scale value (1 = full size, 0.75 = 75%, etc.)
            const scaleSelect = document.getElementById('downloadScale');
            const scale = parseFloat(scaleSelect.value) || 1;
            
            // Calculate scaled dimensions
            const scaledWidth = Math.round(canvas.width * scale);
            const scaledHeight = Math.round(canvas.height * scale);
            
            // Create a temporary canvas for the scaled image
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = scaledWidth;
            tempCanvas.height = scaledHeight;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Use high-quality image smoothing for better scaling
            tempCtx.imageSmoothingEnabled = true;
            tempCtx.imageSmoothingQuality = 'high';
            
            // Draw the original canvas scaled to the new dimensions
            tempCtx.drawImage(canvas, 0, 0, scaledWidth, scaledHeight);
            
            // Create download link with scaled image
            const link = document.createElement('a');
            link.download = `card_${scaleSelect.options[scaleSelect.selectedIndex].text.replace(/[^0-9]/g, '')}x.png`;
            link.href = tempCanvas.toDataURL('image/png');
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Fullscreen functionality
        function openFullscreen() {
            const modal = document.getElementById('fullscreenModal');
            const fullscreenCanvas = document.getElementById('fullscreenCanvas');
            const fullscreenCtx = fullscreenCanvas.getContext('2d');
            
            // Copy the current canvas to the fullscreen canvas
            fullscreenCtx.clearRect(0, 0, fullscreenCanvas.width, fullscreenCanvas.height);
            fullscreenCtx.drawImage(canvas, 0, 0);
            
            modal.style.display = 'block';
        }

        function closeFullscreen() {
            const modal = document.getElementById('fullscreenModal');
            modal.style.display = 'none';
        }

        // Close fullscreen on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeFullscreen();
            }
        });


    </script>
</body>
</html>
